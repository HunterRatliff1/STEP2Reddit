{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Reddit PHQ9\"\nauthor: \"Hunter Ratliff, @HunterRatliff1\"\ndate: \"7/19/2019\"\noutput: html_document\n---\n\n```{r setup}\nknitr::opts_chunk$set(collapse = TRUE, warning=FALSE, message=F, tidy=TRUE) \nsuppressPackageStartupMessages(require(tidyverse))\nsuppressPackageStartupMessages(require(ggthemes))\nsuppressPackageStartupMessages(require(lubridate))\nsuppressPackageStartupMessages(require(stringr))\n\n# Might just be a problem on my system, but I have to run this code\n# to set the timezone so lubridate will work\nSys.setenv(TZ=\"America/Chicago\")\n```\n\n## Import & format data\n\n```{r importData, warning=F, message=F, collapse=T}\nmasterDf <- readr::read_csv(\"~/Downloads/spring_health_take_home_df.csv\",\n                            na = c(\"\", \"NA\", \"N/A\")) %>%\n  select(-X1) %>% # drop the first column\n  \n  # Rename variables to shorter names\n  rename(mid=member_id_hashed, asmt_time=assessment_created_at, \n         qst_kind=questionnaire_kind, qst_time=questionnaire_created_at) %>%\n  \n  # I'm assuming that it's okay to simplify to just the date (not datetime),\n  # but this might not be the case (e.g. if people are taking the PHQ9 / SDS\n  # multiple times a day, or around midnight)\n  mutate(\n    asmt_time = as.Date(asmt_time),\n    qst_time  = as.Date(qst_time)\n  )\n\n# Seperate these out into unique df's to avoid problems with NA. You can\n# join them back together with the dplyr::join fxns\nPHQ <- masterDf %>% filter(qst_kind==\"PHQ9\")\nSDS <- masterDf %>% filter(qst_kind==\"SDS\")\n```\n\n## Corrected code\n\nThis should work to recreate the data frame (at least on my system). FYI, I changed\nthe names of the variables\n\n```{r PHQ_overview}\nPHQ_overview <- PHQ %>%\n  group_by(mid) %>%\n  arrange(qst_time) %>%\n  summarise(\n    nResponses = n(),    # find the total number of responses per user\n    Base.score   = first(PHQ9_score),\n    Recent.score = last(PHQ9_score),\n    Delta.score  = Recent.score - Base.score) %>%\n  ungroup()\n\n\n```\n\nThis should let you get the baseline summary stats\n\n```{r PHQ9_Baseline_summary, collapse=F}\nsummary(PHQ_overview$Base.score)\nsummary(PHQ_overview$Delta.score)\n```\n\n\nYou can use a similar idea to make the graphics by including other variables (in\nthis case `Base.acuity = first(PHQ9_acuity)`) in your summarise() function\n\n```{r}\nPHQ %>%\n  group_by(mid) %>%\n  arrange(qst_time) %>%\n  summarise(\n    Base.score  = first(PHQ9_score),\n    Base.acuity = first(PHQ9_acuity)\n  ) %>%\n  mutate(Base.acuity = factor(Base.acuity, ordered=T,\n                                 levels=c(\"none\", \"mild\", \"moderate\",\n                                          \"moderately severe\", \"severe\"))) %>%\n  ggplot(aes(x=Base.score, fill=Base.acuity)) + \n  geom_histogram(color=\"black\") +\n  scale_fill_brewer(palette = \"Reds\") +\n  labs(x=\"Baseline PHQ9 score\", y=\"# of members\", title=\"Baseline PHQ9 scores\",\n       fill=\"Baseline acuity\")\n```\n\n# SDS score\n\nSo it looks like one of the problems is that some of the responses to the SDS questions\nare incomplete (i.e. they answered some questions, but not all). See snapshot below from\na user I picked at random:\n\n```{r User_Snapshot}\nSDS %>%\n  arrange(qst_time) %>%\n  filter(mid==\"1c3f48e629a99ca2a05d4f38692409cc3b5e778ff9a49c3563c15353e56fc37b\") %>%\n  select(asmt_time, starts_with(\"SDS\")) %>%\n  knitr::kable()\n\n\n```\n\nYou should be able to get around this problem by filtering out the NA's for this\nspecific column (SDS_days_unproductive) before the summarise on the `SDS` df\n\n```{r SDS_productivity}\nSDS_productivity <- SDS %>%\n  filter(!is.na(SDS_days_unproductive)) %>% # ADD THIS LINE\n  group_by(mid) %>%\n  arrange(qst_time) %>%\n  summarise(\n    nResponses = n(),    \n    Base.score   = first(SDS_days_unproductive),\n    Recent.score = last(SDS_days_unproductive),\n    Delta.score  = Recent.score - Base.score) %>%\n  ungroup()\n```\n\nSo your mean productivity score is u = `r mean(SDS_productivity$Delta.score)`.\n\nNow your problem with the cor.test() is that your vectors are not the same length:\n\n```{r nrows}\nnrow(PHQ_overview)\nnrow(SDS_productivity)\n```\n\nIdeally, you'd join the PHQ9 & SDS results together by `mid`, which lets you do \npairwise analysis. For simplicty sake, I'm going to remake these two data frames\nbelow (with new names for the baseline/recent/delta scores)\n\n```{r}\nrm(PHQ_overview)\nrm(SDS_productivity)\n\n# Remake the PHQ9 score df\nPHQ_score <- PHQ %>%\n  filter(!is.na(PHQ9_score)) %>% # Just to be consistent\n  group_by(mid) %>%\n  arrange(qst_time) %>%\n  summarise(\n    PHQ.n      = n(),    \n    PHQ.base   = first(PHQ9_score),\n    PHQ.recent = last(PHQ9_score),\n    PHQ.Delta  = PHQ.recent - PHQ.base) %>%\n  ungroup()\n\n\n# Remake the SDS - Productivity df\nunprdDays <- SDS %>%\n  filter(!is.na(SDS_days_unproductive)) %>% # This is the line I added\n  group_by(mid) %>%\n  arrange(qst_time) %>%\n  summarise(\n    unprdDays.n      = n(),    \n    unprdDays.base   = first(SDS_days_unproductive),\n    unprdDays.recent = last(SDS_days_unproductive),\n    unprdDays.Delta  = unprdDays.recent - unprdDays.base) %>%\n  ungroup()\n```\n\nSince we're looking at the correlation of the delta's, we also only want to \ninclude members who have more than one response (otherwise you're counting a \nbunch of 0's from people who only have one response)\n\n```{r}\nPHQ_score <- PHQ_score %>% filter(PHQ.n>1)\nunprdDays <- unprdDays %>% filter(unprdDays.n>1)\n```\n\nFinally, we'll join the two df's together. You can use `full_join()` or `inner_join`,\nbut I'll pick inner_join because it'll get rid of the NAs. \n\n```{r}\njoinedDf <- inner_join(PHQ_score, unprdDays)\n```\n\nNow you should be able to run the cor.test with the new df\n\n```{r}\ncor.test(~PHQ.Delta + unprdDays.Delta, data=joinedDf)\n```\n\n```{r}\njoinedDf %>% \n  ggplot(aes(x=PHQ.Delta, y=unprdDays.Delta)) + \n  geom_jitter(alpha=0.3) + \n  geom_smooth(method=lm)\n```\n\n\n\n",
    "created" : 1563554283524.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "849940094",
    "id" : "CD5BC2F1",
    "lastKnownWriteTime" : 1563580288,
    "last_content_update" : 1563580288517,
    "path" : "~/Github/Stackoverflow:Reddit/Reddit PHQ9/RedditPHQ_question.Rmd",
    "project_path" : null,
    "properties" : {
        "docOutlineVisible" : "0",
        "last_setup_crc32" : "F2BB969Baefcf62b",
        "tempName" : "Untitled1"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}